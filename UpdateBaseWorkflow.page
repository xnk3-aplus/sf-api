<apex:page standardController="Case" lightningStylesheets="true">
    <apex:form >
        <apex:pageBlock title="Sync Case to Base Workflow">
             <apex:pageBlockSection columns="1">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Case Number:" />
                    <apex:outputText value="{!Case.CaseNumber}" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Subject:" />
                    <apex:outputText value="{!Case.Subject}" />
                </apex:pageBlockSectionItem>
                
                 <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Status:" />
                    <apex:outputPanel id="statusPanel">
                        <span id="statusMessage" style="font-weight: bold;"></span>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            
            <apex:pageBlockButtons location="bottom">
                <button type="button" 
                        class="btn btn-primary" 
                        id="syncButton" 
                        onclick="syncToBase(); return false;">
                    Sync to Base Workflow
                </button>
            </apex:pageBlockButtons>
        </apex:pageBlock>
    </apex:form>
    
    <script>
        // API Configuration
        // Note: Change this URL to your deployed API URL if different
        const API_BASE_URL = 'https://sf-api-three.vercel.app'; 
        const CASE_ID = '{!Case.Id}';
        
        function setStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            if (type === 'loading') {
                statusEl.style.color = '#0070d2'; // Blue
            } else if (type === 'success') {
                statusEl.style.color = '#04844b'; // Green
            } else if (type === 'error') {
                statusEl.style.color = '#c23934'; // Red
            }
        }
        
        async function syncToBase() {
            const button = document.getElementById('syncButton');
            
            try {
                button.disabled = true;
                button.textContent = 'Syncing...';
                setStatus('Syncing with Base Workflow...', 'loading');
                
                // Call API
                const url = API_BASE_URL + '/sync-base-workflow?case_id=' + CASE_ID;
                console.log('Calling URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (data.status === 'success') {
                        setStatus('Success: ' + data.action + ' Job for subject: ' + data.case_subject, 'success');
                        button.textContent = 'Synced';
                    } else {
                        setStatus('Error: ' + (data.message || 'Unknown error'), 'error');
                        button.disabled = false;
                        button.textContent = 'Sync to Base Workflow';
                    }
                } else {
                    const errorText = await response.text();
                    console.error('HTTP Error:', errorText);
                    setStatus('Error HTTP: ' + response.status, 'error');
                    button.disabled = false;
                    button.textContent = 'Sync to Base Workflow';
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                setStatus('Error: ' + error.message, 'error');
                button.disabled = false;
                button.textContent = 'Sync to Base Workflow';
            }
        }
    </script>
    
    <style>
        .btn {
            border: 1px solid transparent;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: #0070d2;
            border-color: #0070d2;
            color: #fff;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #005fb2;
            border-color: #005fb2;
        }
        
        .btn:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #statusMessage {
            font-size: 13px;
        }
    </style>
</apex:page>