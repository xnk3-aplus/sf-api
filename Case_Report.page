<apex:page standardController="Case" lightningStylesheets="true">
    <apex:form >
        <apex:pageBlock title="Generate Case Report (Complaint)">
            <apex:pageBlockSection columns="1">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Case ID:" />
                    <apex:outputText value="{!Case.Id}" />
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Case Number:" />
                    <apex:outputText value="{!Case.CaseNumber}" />
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Subject:" />
                    <apex:outputText value="{!Case.Subject}" />
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Status:" />
                    <apex:outputPanel id="statusPanel">
                        <span id="statusMessage" style="font-weight: bold;"></span>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            
            <apex:pageBlockButtons location="bottom">
                <button type="button" 
                        class="btn btn-primary" 
                        id="generateButton" 
                        onclick="generateDocument(); return false;">
                    Generate Case Report
                </button>
                
                <button type="button" 
                        class="btn btn-primary" 
                        id="syncWorkflowButton" 
                        disabled="true"
                        style="margin-left: 10px;"
                        onclick="syncToBaseWorkflow(); return false;">
                    Sync to Base Workflow
                </button>
                
                <button type="button" 
                        class="btn btn-primary" 
                        id="syncServiceButton" 
                        disabled="true"
                        style="margin-left: 10px;"
                        onclick="syncToBaseService(); return false;">
                    Sync to Base Service
                </button>
            </apex:pageBlockButtons>
        </apex:pageBlock>
    </apex:form>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'https://sf-api-three.vercel.app';
        const RECORD_ID = '{!Case.Id}';
        const RECORD_NAME = '{!JSENCODE(Case.CaseNumber)}';
        
        // Get Session ID for Salesforce API calls (needed to delete old files)
        const SESSION_ID = '{!$Api.Session_ID}';
        
        // Update status message
        function setStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            
            // Set color based on type
            if (type === 'loading') {
                statusEl.style.color = '#0070d2'; // Blue
            } else if (type === 'success') {
                statusEl.style.color = '#04844b'; // Green
            } else if (type === 'error') {
                statusEl.style.color = '#c23934'; // Red
            }
        }
        
        // Close modal and refresh parent
        function closeAndRefresh() {
            try {
                if (typeof sforce !== 'undefined' && sforce.one) {
                    sforce.one.back(true);
                    return;
                }
                
                if (window.parent && window.parent.$A) {
                    window.parent.$A.get('e.force:refreshView').fire();
                    window.parent.$A.get("e.force:closeQuickAction").fire();
                    return;
                }
                
                if (window.parent && window.parent !== window) {
                    window.parent.location.href = window.parent.location.href;
                    return;
                }
                
                window.location.reload();
            } catch (e) {
                console.error('Error closing modal:', e);
                window.location.reload();
            }
        }

        // --- Delete old "Case_" files ---
        async function deleteOldFiles() {
            setStatus('Checking for old reports...', 'loading');
            
            try {
                // Query for ContentDocumentLinks attached to this record where title starts with "Case_"
                const query = `SELECT ContentDocumentId FROM ContentDocumentLink WHERE LinkedEntityId = '${RECORD_ID}' AND ContentDocument.Title LIKE 'Case_%'`;
                const queryUrl = window.location.origin + '/services/data/v57.0/query/?q=' + encodeURIComponent(query);

                const queryResponse = await fetch(queryUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + SESSION_ID,
                        'Content-Type': 'application/json'
                    }
                });

                if (!queryResponse.ok) {
                    console.warn("Could not query old files, proceeding to generation anyway.");
                    return;
                }

                const queryData = await queryResponse.json();
                
                if (queryData.records && queryData.records.length > 0) {
                    setStatus(`Deleting ${queryData.records.length} old report(s)...`, 'loading');
                    
                    const deletePromises = queryData.records.map(record => {
                        const docId = record.ContentDocumentId;
                        const deleteUrl = window.location.origin + '/services/data/v57.0/sobjects/ContentDocument/' + docId;
                        
                        return fetch(deleteUrl, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + SESSION_ID
                            }
                        });
                    });

                    await Promise.all(deletePromises);
                    console.log('Old reports deleted successfully');
                }
                
            } catch (error) {
                console.error('Error deleting old files:', error);
            }
        }
        
        // Call API to generate document
        async function generateDocument() {
            const button = document.getElementById('generateButton');
            try {
                // Disable button and show loading
                button.disabled = true;
                button.textContent = 'Processing...';
                
                // --- STEP 1: Delete Old Files ---
                await deleteOldFiles();

                // --- STEP 2: Generate New File ---
                setStatus('Calling AI and Generating Report...', 'loading');
                button.textContent = 'Generating...';
                
                // Call the API
                const response = await fetch(API_BASE_URL + '/generate-case-report/' + RECORD_ID, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    setStatus('Case Report generated successfully! You can now sync to Base.', 'success');
                    button.textContent = 'Generate Complete';
                    
                    // Enable Sync Buttons
                    document.getElementById('syncWorkflowButton').disabled = false;
                    document.getElementById('syncServiceButton').disabled = false;
                    
                    // Removed auto-close to allow user to click sync buttons
                    // setTimeout(function() {
                    //    closeAndRefresh();
                    // }, 1500);
                } else {
                    const errorText = await response.text();
                    console.error('HTTP error:', response.status, errorText);
                    setStatus('Error: ' + response.status + ' ' + errorText, 'error');
                    button.disabled = false;
                    button.textContent = 'Generate Case Report';
                }
                
            } catch (error) {
                console.error('Generate error:', error);
                setStatus('Error: ' + error.message, 'error');
                button.disabled = false;
                button.textContent = 'Generate Case Report';
            }
        }
        
        async function syncToBaseWorkflow() {
            const button = document.getElementById('syncWorkflowButton');
            try {
                button.disabled = true;
                button.textContent = 'Syncing Workflow...';
                setStatus('Syncing with Base Workflow...', 'loading');
                
                const response = await fetch(API_BASE_URL + '/sync-base-workflow?case_id=' + RECORD_ID, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        setStatus('Synced to Base Workflow Successfully!', 'success');
                        button.textContent = 'Workflow Synced';
                    } else {
                        setStatus('Workflow Sync Error: ' + (data.message || 'Unknown'), 'error');
                        button.textContent = 'Sync Failed';
                        button.disabled = false;
                    }
                } else {
                    const txt = await response.text();
                    setStatus('Workflow HTTP Error: ' + response.status, 'error');
                    button.disabled = false;
                }
            } catch (e) {
                setStatus('Workflow Error: ' + e.message, 'error');
                button.disabled = false;
            }
        }

        async function syncToBaseService() {
            const button = document.getElementById('syncServiceButton');
            try {
                button.disabled = true;
                button.textContent = 'Syncing Service...';
                setStatus('Syncing with Base Service...', 'loading');
                
                const response = await fetch(API_BASE_URL + '/sync-base-service?case_id=' + RECORD_ID, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        setStatus('Synced to Base Service Successfully!', 'success');
                        button.textContent = 'Service Synced';
                    } else {
                        setStatus('Service Sync Error: ' + (data.message || 'Unknown'), 'error');
                        button.textContent = 'Sync Failed';
                        button.disabled = false;
                    }
                } else {
                    const txt = await response.text();
                    setStatus('Service HTTP Error: ' + response.status, 'error');
                    button.disabled = false;
                }
            } catch (e) {
                setStatus('Service Error: ' + e.message, 'error');
                button.disabled = false;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setStatus('Ready to generate Case Report', 'loading');
        });
    </script>
    
    <style>
        .btn {
            border: 1px solid transparent;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: #0070d2;
            border-color: #0070d2;
            color: #fff;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #005fb2;
            border-color: #005fb2;
        }
        
        .btn:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #statusMessage {
            font-size: 13px;
        }
    </style>
</apex:page>
